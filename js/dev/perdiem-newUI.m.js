function validateInput(){var e="length",t="#queryZip",n="addClass",r="form.perdiem .location",i="error",s="form.perdiem .location .help-inline",o="hasPrefix",u=!1,a="removeClass",f="#endDate",l="form.perdiem .dates",c="form.perdiem .dates .help-inline";if($("#queryState").val()[e]>0||$(t).val()[e]>0)if($(t).val()[e]>0&&!/^\s*\d{5}\s*$/.test($(t).val())){$(r)[n](i);$(s).text("Please enter a valid 5 number Zip Code.")}else{var h=$(t).val();if(h.inRange(96910,96932)||h===96799||h[o]("008")||h[o]("006")||h[o]("007")||h[o]("009")){$(r)[n](i);$(s).html('Rates for this location are administrated by the <a href="http://www.defensetravel.dod.mil/site/perdiemCalc.cfm">Department of Defense.</a>');return u}$(r)[a](i);$(s).html("");if(moment($(f).val()).isBefore(moment($("#startDate").val()))){$(l)[n](i);$(c).text("End date cannot be set before start date.");return u}if(!moment($(f).val(),"YYYY-MM-DD").isBefore("2014-10-01")){$(l)[n](i);$(c).text("Rates are not yet available for these dates.");return u}perDiemSearch("main");analytics("Calculator");$(l)[a](i);$(c).html("")}else{$(r)[n](i);$(s).text("Please enter State or ZIP.")}}function perDiemSearch(e){function u(t){$.getJSON(theQuery.request(),function(n){if(n[i][0]===undefined){fail(s,o);return!1}result=n[i][0];data.push(n[i][0]);if(t===2)a();else if(data[0].rate.length>1)chooseRates(data);else{ratei=0;process();view(e)}}).error(function(){setTimeout(function(){u(t)},1e3)})}function a(){$.getJSON(theQuery.request1(),function(e){if(e[i][0]===undefined){fail(s,o);return!1}result=e[i][0];ratei=0;data.push(e[i][0])}).success(function(){if(data[0].rate.length>1)chooseRates(data);else{process();view(e)}}).error(function(){setTimeout(function(){a()},1e3)})}var t="#load",n="permalink",r="YYYY-MM-DD",i="rates",s="Your search returned no results.",o="Please make sure your search query is valid, and try again.";$("#fail").html("");$(t).show();$(window).width()<699&&$("html, body").animate({scrollTop:$(t).offset().top},500);$("#chooseRates").hide();$("#results").hide();if(e!==n){startDate=moment($("#startDate").val(),r);endDate=moment($("#endDate").val(),r)}else{startDate=moment(startDate,r);endDate=moment(endDate,r)}startYear=startDate.year();endYear=endDate.year();if(e==="geo"){theQuery=new Query(baseURL,geoZip,"","");startDate=today;endDate=today}e==="main"&&(theQuery=new Query(baseURL,$("#queryZip").val(),$("#queryCity").val(),stateAbbrev($("#queryState").val())));e===n&&(theQuery=new Query(baseURL,permaZip,permaCity,permaState));data=[];startYear===2014?u():u(2);startTimers()}function Query(e,t,n,r){var i="year/",s="/",o="length",u=i+startYear+s,a=i+parseInt(startYear+1)+s,f="",l="",c="";n[o]>0&&(f="city/"+n+s);r[o]>0&&(l="state/"+r+s);if(t[o]>0){c="zip/"+t+s,f="";l=""}this.zip=function(){return t};this.city=function(){return n};this.state=function(){return r};this.year=function(){return date.year()};this.request=function(){return e+f+l+c+u};this.request1=function(){return e+f+l+c+a}}function DoMath(){var e="month",t="daysInMonth";if(startYear===endYear)var n=Math.abs(endDate[e]()-startDate[e]());else var n=Math.abs(endDate[e]()+12-startDate[e]());var r=[];for(var i=0;i<=n;i++){var s=moment(startDate).add("months",i),o=s[e](),u=s.year(),a,f=theRates.lodging(o,u),l=theRates.mie(u);i===0?startDate[e]()===endDate[e]()?a=endDate.date()-startDate.date()+1:a=startDate[t]()-startDate.date()+1:i===n?a=endDate.date():a=s[t]();if(i===n)var c=(a-1)*f;else var c=a*f;if(startDate[e]()===endDate[e]())var h=(a-2)*l+l*.75*2;else if(i===0||i===n)var h=(a-1)*l+l*.75;else var h=a*l;var p=h+c;r.push([o,u,a,f,l,c,h,p])}var d=0,v=0,h=0,m=0;for(var i=0;i<r.length;i++){i===0?d=d+r[i][2]-1:d+=r[i][2];v+=r[i][5];h+=r[i][6];m+=r[i][7]}var g=r.length-1;m=h+v;var y=r[0][4]*.75,b=r[g][4]*.75;this.firstDayMIE=function(){return y};this.lastDayMIE=function(){return b};this.array=function(){return r};this.totalLodging=function(){return v};this.totalMIE=function(){return h};this.totalDays=function(){return d};this.total=function(){return m}}function Rates(){this.lodging=function(e,t){function r(e,t){for(i=0;i<12;i++)if(t[i]["number"]==e){monthRate=parseInt(t[i].value);return monthRate}}if(t!==startYear)var n=1;else var n=0;if(e>8&&t===startYear)var n=1;var s=r(e+1,data[n].rate[ratei].months.month);return s};this.mie=function(e){var t=0;if(e!==startYear)var t=1;return data[t].rate[ratei].meals}}function view(e){var t="hide",n="html",r="#results table tbody",i="geo",s="format",o="YYYY-MM-DD",u="append",a="</td><td>$",f="firstDayMIE",l="lastDayMIE",c="</td>",h="#totals h4 strong",p="#totals",d="</strong></li></ul>",v="#results #saveSearch .link",m="#saveSearch .email",g="href",y="#results";clearTimers();var b=theMath.array();$("#fail")[t]();$(r)[n]("");$("#results #totals ul").remove();$("#results #totals")[t]();$("#results #today")[t]();$("#chooseRates ul")[n]("");$("#chooseRates")[t]();$("#results #yourSearch")[n]("Your search "+searchedFor()+"matches results for "+data[0].rate[ratei].city+", including "+county(data[0].rate[ratei].county)+":");e!==i&&(startDate[s](o)!==endDate[s](o)?$(r)[u]('<tr class="firstLast"><td scope="row">First Day</td><td>$'+currency(b[0][3])+a+currency(theMath[f]())+a+currency(b[0][3]+theMath[l]())+c):$(r)[u]('<tr class="firstLast"><td scope="row">First Day</td><td>N/A</td><td>$'+currency(theMath[f]())+a+currency(theMath[f]())+c));$.each(b,function(e){$(r)[u]('<tr><td scope="row">'+theMonths[b[e][0]]+" Rate</td><td>$"+currency(b[e][3])+a+currency(b[e][4])+a+currency(b[e][3]+b[e][4])+c)});startDate[s](o)!==endDate[s](o)&&$(r)[u]('<tr class="firstLast"><td scope="row">Last Day</td><td>-</td><td>$'+currency(theMath[l]())+a+currency(theMath[l]())+c);if(e===i)$("#today").show();else if(startDate[s](o)===endDate[s](o)){$(h)[n]("$"+currency(theMath[l]()));$(p)[u]('<ul class="unstyled"><li>Lodging <strong>N/A</strong></li><br><li>M&amp;IE <strong>$'+currency(theMath[l]())+d).show()}else{$(h)[n]("$"+currency(theMath.total()));$(p)[u]('<ul class="unstyled"><li>Lodging <strong>$'+currency(theMath.totalLodging())+"</strong></li><br><li>M&amp;IE <strong>$"+currency(theMath.totalMIE())+d).show()}if(e===i){$(v).val(mRoot+"/#!/travel/perdiem/?mylocation");$(m).attr(g,"mailto:?subject=My%20Per%20Diem%20Rates&body=http%3A%2F%2Fm.gsa.gov%2Fm%2F%23%21%2Ftravel%2Fperdiem%2F%3Fmylocation")}else{$(v).val(mRoot+"/#!/travel/perdiem/?start="+startDate[s](o)+"&end="+endDate[s](o)+"&zip="+theQuery.zip()+"&city="+theQuery.city()+"&state="+theQuery.state());$(m).attr(g,"mailto:?subject=My%20Per%20Diem%20Rates&body=http%3A%2F%2Fm.gsa.gov%2Fm%2F%23%21%2Ftravel%2Fperdiem%2F%3Fstart%3D"+startDate[s](o)+"%26end%3D"+endDate[s](o)+"%26zip%3D"+theQuery.zip()+"%26city%3D"+theQuery.city()+"%26state%3D"+theQuery.state())}$("#load")[t]();$(y).css("opacity","0").show().addClass("fadeInDown animated");$(window).width()<699&&$("html, body").animate({scrollTop:$(y).offset().top},500)}function analytics(e){typeof _gaq!="undefined"&&_gaq.push(["_trackEvent","Per Diem",e])}function searchedFor(){var e="length",t="#queryCity",n="#queryZip",r;if($(t).val()[e]>0)r=capitalize($(t).val());else if($(t).val()[e]!==0||$(n).val()[e]!==0)r=$(n).val();r!=undefined?r='for "'+r+'" ':r="";return r}function county(e){var t="indexOf";return e[t](",")>0&&e[t]("counties")===0?e+" counties":e[t]("(")>0||e[t](";")>0?e:e+" county"}function process(){theRates=new Rates;theMath=new DoMath}function fail(e,t,n){var r="#fail";$(r).hide();n!==!1&&$("#load").hide();$("#results").hide();e===undefined?$(r).html("").append('<div class="alert alert-error"><h4>Your Search Returned No Results.</h4><br><p>Please try again.</p></div>'):$(r).html("").append('<div class="alert alert-error"><h4>'+e+"</h4><br><p>"+t+"</p></div>");$(window).width()<699&&$("html, body").animate({scrollTop:$(r).offset().top},500);$(r).show()}function chooseRates(e){var t="#chooseRates ul",n="#chooseRates",r="#load",i="YYYY-MM-DD";$(t).html("");$.each(e[0].rate,function(n){e[0].rate[n].city===""?$(t).append('<li><a href="#">All other locations</a></li>'):$(t).append('<li><a href="#">'+e[0].rate[n].city+"</a></li>")});$(n).css("opacity","0").show().addClass("fadeInDown animated");$(r).hide();$(window).width()<699&&$("html, body").animate({scrollTop:$(n).offset().top},500);$("#chooseRates li").click(function(){var t=$(this).index();ratei=t;e.push(e[0]);$(r).show();process();startDate.format(i)===endDate.format(i)?view(!1):view();return!1});clearTimers()}function stateAbbrev(e){e=e.toLowerCase();return e.length>2?theStates[e]!=undefined?theStates[e]:"":e.toUpperCase()}function daysInMonth(e,t){return(new Date(t,e,0)).getDate()}function currency(e){return e.toString().indexOf(".")!==-1?e.toFixed(2):e+".00"}function capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}function getLocation(){if(Modernizr.geolocation){navigator.geolocation.getCurrentPosition(reverseGeocode,geocodeError);geocoder=new google.maps.Geocoder;$("#load").show();$(window).width()<699&&$("html, body").animate({scrollTop:$("#load").offset().top},500)}else $("#geoLocation").addClass("disabled").html("Geolocation is not available on this device")}function reverseGeocode(e){var t="address_components",n=e.coords.latitude,r=e.coords.longitude,i=new google.maps.LatLng(n,r);geocoder.geocode({latLng:i},function(e,n){if(n==google.maps.GeocoderStatus.OK){zipObject=e[0][t].length-1;geoZip=e[0][t][zipObject].long_name;perDiemSearch("geo");$("#geoLocation").addClass("disabled")}else fail("Your location could not be determined.","Try searching manually, or set your device to allow location access.")})}function geocodeError(e){var t="#fail",n="";switch(e.code){case e.PERMISSION_DENIED:n="<h4>You have disallowed access to your location.</h4><br><p>Try searching manually, or set your device to allow location access.</p>";break;case e.POSITION_UNAVAILABLE:n="<h4>Your location could not be determined.</h4><br><p>Try searching manually, or enabling your device's data, WiFi, and location services.</p>";break;case e.PERMISSION_DENIED_TIMEOUT:n="<div class='alert alert-error'><h4>Your location could not be determined.</h4><br><p>Try searching manually, or enabling your device's data, WiFi, and location services.</p></div>"}n==""&&(n="<h4>Your location could not be determined due to an unknown error.</h4><br><p>Try searching manually, or enabling your device's data, WiFi, and location services.</p>");$(t).html("");$("#results").hide();$(t).append("<div class='alert alert-error'>"+n+"</div>").show();$("#load").hide()}function permalink(){var e="replace",t=window.location.href.split("?");urlVars=t[1].split("&");startDate=urlVars[0][e]("start=",""),endDate=urlVars[1][e]("end=",""),permaZip=urlVars[2][e]("zip=","");permaCity=urlVars[3][e]("city=","");permaState=urlVars[4][e]("state=","");permaCity!==""&&$("#queryCity").val(permaCity);permaState!==""&&$("#queryState").val(permaState);permaZip!==""&&$("#queryZip").val(permaZip);$("#startDate").val(startDate);$("#endDate").val(endDate);perDiemSearch("permalink");analytics("Permalink")}function startTimers(){var e="This seems to be taking a while...";timer10=setTimeout(function(){fail(e,"Loading results requires an internet connection. If you're mobile, make sure you are still connected to 3G/4G/WiFi.",!1)},1e4),timer30=setTimeout(function(){fail(e,"This app will continue trying to collect results until you search again, or navigate to another page.",!1)},3e4)}function clearTimers(){clearTimeout(timer10);clearTimeout(timer30)}var baseURL=root+"/api/rs/perdiem/",data,topLevelData,stateAbbrev,theQuery,geocoder,geoZip,permaZip,urlVars,today,startDate,endDate,startYear,endYear,theRates,theMath,ratei,timer10,timer30,theCities=["Aberdeen","Abingdon","Aiken","Akron","Albany","Alexandria","Allentown","Anacortes","Andover","Ann Arbor","Annapolis","Antioch","Appleton","Arcata","Arlington","Asheville ","Aspen","Athens","Atlanta","Atlantic Beach","Atlantic City","Auburn Hills ","Augusta","Aurora","Austin","Bakersfield","Baltimore City","Baltimore County","Bar Harbor","Barstow","Baton Rouge","Battle Creek ","Beaverton","Bel Air","Belcamp","Belle Mead","Bellevue","Belmont","Bend","Benton Harbor","Berwyn","Bethlehem","Beulah","Big Sky","Big Spring","Binghamton","Birmingham","Blacksburg","Bloomington ","Boca Raton","Bolingbrook","Bonner's Ferry","Boone County","Boston","Boulder","Bradenton","Breckenridge","Brentwood","Bridgeport","Bristol","Brookfield","Broomfield","Brunswick","Bucks County","Buffalo","Burlington","Burnsville","Butte","Cambridge","Canton","Cape May","Carlsbad","Carmel","Cedar Rapids","Centreville","Chapel Hill","Charleston","Charlotte","Charlottesville","Chattanooga ","Cherry Hill","Chesapeake","Chester","Chicago","Cincinnati","Clackamas","Cleveland","Cocoa Beach","Cody","Coeur d'Alene","College Station","Collinsville","Colorado Springs","Columbia","Columbus","Concord","Conway","Corpus Christi","Cortez","Coupeville","Covington","Cranford","Crested Butte","Cromwell","Dallas","Dallas County","Danbury","Davis","Dayton","Daytona Beach","De Funiak Springs","Death Valley","Delray Beach","Denver","Des Moines","Detroit","Dickinson","District of Columbia","Douglas County","Dover","Driggs","Duluth","Durango","Durham","Eagan","East Greenwich","East Lansing","Easton","Eatontown","Edison","El Paso","Enid","Erie","Essington","Eugene","Eureka","Evanston","Everett","Fairborn","Fairview Heights","Falmouth","Fayetteville","Flagstaff","Flemington","Floral Park","Florence","Fort Collins","Fort Lauderdale","Fort Myers","Fort Walton Beach","Fort Worth","Foster City","Franklin","Frazer","Frederick","Fredericksburg","Freehold","Fresno","Ft. Wayne","Gainesville","Galveston","Garden City","Gettysburg","Gillette","Glendive","Glens Falls","Glenwood Springs","Grand Canyon","Grand Junction","Grand Rapids","Grapevine","Great Neck","Greensboro","Greenville","Groton","Gualala","Gulf Breeze","Gulf Shores","Gunnison","Hamilton","Hammond","Harrisburg","Hartford","Hattiesburg","Havelock","Helena","Hershey","Hilton Head","Holland","Hot Springs","Houston (L.B. Johnson Space Center)","Huntsville","Hyannis","Idaho Falls","Incline Village","Indianapolis","Ithaca","Jackson","Jamestown","Jekyll Island","Jupiter","Kalamazoo","Kalispell","Kansas City","Kennebunk","Kenton County","Ketchum","Key West","Kill Devil","Kingston","Kittery","Knoxville","Laconia","Lafayette","Lake Geneva","Lake Placid","Lakeville","Lancaster","Lansing","Laredo","Las Cruces","Las Vegas","Laurel","Lebanon","Leesville","Lemont","Lemoore","Leonardtown","Lewes","Lexington","Lexington Park","Lincoln","Lincoln City","Little Rock","Los Alamos","Los Angeles","Loudoun County","Louisville","Loveland","Lusby","Lynchburg","Lynnwood","Mackinac Island","Madison","Malvern","Mammoth Lakes","Manassas","Manchester","Martha's Vineyard","McAllen","McKinleyville","Mechanicsburg","Medina","Melville","Memphis","Mendota Heights","Mentor","Merrillville","Miami","Middlebury","Middletown","Midland","Mill Valley","Milwaukee","Minneapolis","Minot","Missoula","Moab","Mobile","Modesto","Monterey","Montgomery County","Montpelier","Montrose","Moorestown","Morehead City","Morgantown","Munster","Muskegon","Myrtle Beach","Nantucket","Napa","Naples","Nashville","Natchitoches","New Bedford","New Bern","New Haven","New London","New Orleans","New Providence","New Rochelle","New York City (Manhattan"," Brooklyn"," the Bronx"," Queens and Staten Island)","Newark","Newport","Niagara Falls","Norfolk","North Kingstown","Northampton","Novato","Nyack","O'Fallon","Oak Brook Terrace","Oak Harbor","Oak Ridge","Oakhurst","Oakland","Ocean City","Ocean Shores","Oklahoma City","Old Saybrook","Olympia","Omaha","Ontario","Orlando","Oswego","Overland Park","Owego","Oxford","Palisades","Palm Springs","Palo Alto","Panama City","Park City","Parsippany","Pasco","Pearsall","Pensacola ","Petoskey","Philadelphia","Phoenix","Pinedale","Piscataway","Pittsburgh","Pittsfield","Plano","Plymouth","Point Arena","Polson","Pontiac","Port Angeles","Port Townsend","Portland","Portsmouth","Poughkeepsie","Prince William County","Princeton","Providence","Provo","Punta Gorda","Quincy","Racine","Radnor","Raleigh","Rapid City","Reading","Redding","Reno","Richland","Richmond","Ridgecrest","Riverhead","Roanoke","Rochester","Rock Springs","Rockport","Romeoville","Romulus","Ronkonkoma","Round Rock ","Sacramento","Salisbury","Salt Lake City","San Antonio","San Diego","San Francisco","San Jose","San Luis Obispo","San Mateo","San Rafael","Sandpoint","Sandusky","Sanford","Santa Barbara","Santa Cruz","Santa Fe","Santa Monica ","Santa Rosa","Sarasota","Saratoga Springs","Savannah","Schenectady","Scottsdale","Scranton","Seaside","Seattle","Sebring","Sedona","Sheboygan","Sheridan","Sidney","Silverthorne","Slidell","South Bend","South Haven","South Lake Tahoe","South Padre Island","Southaven","Sparks","Spearfish ","Spokane","Springfield","Springfield ","St. Albans","St. Augustine","St. Joseph","St. Louis","St. Michaels","St. Paul","St. Petersburg","Starkville ","State College ","Stateline"," Carson City","Steamboat Springs","Stevensville","Stockton ","Stowe ","Stuart","Sturgeon Bay","Sturgis","Suffolk","Sun Valley","Sunnyvale","Syracuse","Tacoma","Tahoe City","Tallahassee","Tampa","Taos","Tarrytown","Taunton","Telluride","Toms River","Traverse City and Leland","Trenton","Troy ","Truckee","Tucson","Tumwater","Vail","Vancouver","Vero Beach","Victorville","Virginia Beach","Visalia","Waco","Wallops Island","Warrenton ","Warwick","Waterloo","Watertown","West Lafayette","West Lebanon","West Point","West Sacramento","West Yellowstone","Wheeling","White Plains","White River Junction","Wichita","Williamsburg","Williston","Wilmington","Wisconsin Dells","Woburn","Wooster","Worcester","York","Yosemite National Park","Youngstown"];$(function(){var e="#startDate",t="YYYY-MM-DD",n="#endDate",r="href",s="location",o="Geolocation",u="click",a="body",f="pickadate",l="yyyy-mm-dd",c="picker",h="#startDate_root .picker__frame",p="#endDate_root .picker__frame",d="removeClass",v="$node",m="pulse animated",g="addClass",y="fadeInDownBig animated",b="100%",w="hidden",E="auto",S="scroll";console.log("DOC READY");today=moment();$(e).val(today.format(t));$(n).val(today.add("days",1).format(t));window[s][r].indexOf("?start")>0&&permalink();if(window[s][r].indexOf("?mylocation")>0){analytics(o);getLocation()}$("#search")[u](function(){validateInput();return!1});$("#searchAgain")[u](function(){$("#searchBox").show();$(window).width()<699&&$("html, body").animate({scrollTop:$(a).offset().top},500)});$("#geoLocation")[u](function(){$("#queryState,#queryCity,#queryZip").val("");analytics(o);getLocation();return!1});$("#saveSearch .link")[u](function(){this.select()});$("#saveSearch button")[u](function(){window[s][r]=$(this).attr(r)});if(Modernizr.inputtypes.date)$("#startDate,#endDate").attr("type","date");else{var x=$(e)[f]({format:l,min:[2012,1,1],max:[2014,8,31]}),T=$(n)[f]({format:l,min:[2012,1,1],max:[2014,8,31]}),N=x[f](c),C=T[f](c);$(h).prepend("<h2>Start Date</h2>");$(p).prepend("<h2>End Date</h2>");N.on({open:function(){this[v][d](m);$(h)[g](y);$(a).css({width:b,height:b,overflow:w})},set:function(){this[v][g](m);$(a).css({width:E,height:E,overflow:S});L()}});C.on({open:function(){this[v][d](m);$(p)[g](y);$(a).css({width:b,height:b,overflow:w})},set:function(){this[v][g](m);$(a).css({width:E,height:E,overflow:S});k()}});function k(){var e=$(n).val();e=e.split("-");for(i=0;i<e.length;i++)e[i]=parseFloat(e[i]);startDate.set("max",e)}function L(){var t=$(e).val();t=t.split("-");for(i=0;i<t.length;i++)t[i]=parseFloat(t[i]);startDate.set("min",t)}}$("#queryCity").autocomplete({lookup:theCities,lookupLimit:5,appendTo:$("#queryCityAutocomplete")})});String.prototype.inRange=function(e,t){var n=parseInt(this);return n>e&&n<t};String.prototype.hasPrefix=function(e){var t=this.substring(0,3);return t===e?!0:!1};var theMonths=["January","February","March","April","May","June","July","August","September","October","November","December"],theStates={alabama:"al",alaska:"ak",arizona:"az",arkansas:"ar",california:"ca",colorado:"co",connecticut:"ct",delaware:"de",florida:"fl",georgia:"ga",hawaii:"hi",idaho:"id",illinois:"il",indiana:"in",iowa:"ia",kansas:"ks",kentucky:"ky",louisiana:"la",maine:"me",maryland:"md",massachusetts:"ma",michigan:"mi",minnesota:"mn",mississippi:"ms",missouri:"mo",montana:"mn",nebraska:"ne",nevada:"nv","new hampshire":"nh","new jersey":"nj","new mexico":"nm","new york":"ny","north carolina":"nc","north dakota":"nd",ohio:"oh",oklahoma:"ok",oregon:"or",pennsylvania:"pa","rhode island":"ri","south carolina":"sc","south dakota":"sd",tennessee:"tn",texas:"tx",utah:"ut",vermont:"vt",virginia:"va",washington:"wa","west virginia":"wv",wisconsin:"wi",wyoming:"wy"};