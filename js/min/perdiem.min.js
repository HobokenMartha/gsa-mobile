function validateInput(){if($("#queryState").val().length>0||$("#queryZip").val().length>0)if($("#queryZip").val().length>0&&!/^\s*\d{5}\s*$/.test($("#queryZip").val()))$("form.perdiem .location").addClass("error"),$("form.perdiem .location .help-inline").text("Please enter a valid 5 number Zip Code.");else{var a=$("#queryZip").val();if(a.inRange(96910,96932)||96799===a||a.hasPrefix("008")||a.hasPrefix("006")||a.hasPrefix("007")||a.hasPrefix("009"))return $("form.perdiem .location").addClass("error"),$("form.perdiem .location .help-inline").html('Rates for this location are administrated by the <a href="http://www.defensetravel.dod.mil/site/perdiemCalc.cfm">Department of Defense.</a>'),!1;if($("form.perdiem .location").removeClass("error"),$("form.perdiem .location .help-inline").html(""),moment($("#endDate").val()).isBefore(moment($("#startDate").val())))return $("form.perdiem .dates").addClass("error"),$("form.perdiem .dates .help-inline").text("End date cannot be set before start date."),!1;if(!moment($("#endDate").val(),"YYYY-MM-DD").isBefore("2015-10-01"))return $("form.perdiem .dates").addClass("error"),$("form.perdiem .dates .help-inline").text("Rates are not yet available for these dates."),!1;perDiemSearch("main"),analytics("Calculator"),$("form.perdiem .dates").removeClass("error"),$("form.perdiem .dates .help-inline").html("")}else $("form.perdiem .location").addClass("error"),$("form.perdiem .location .help-inline").text("Please enter State or ZIP.")}function perDiemSearch(a){function b(d){$.getJSON(theQuery.request(),function(b){return void 0===b.rates[0]?(fail("Your search returned no results.","Please make sure your search query is valid, and try again."),!1):(result=b.rates[0],data.push(b.rates[0]),2===d?c():data[0].rate.length>1?chooseRates(data):(ratei=0,process(),view(a)),void 0)}).error(function(){setTimeout(function(){b(d)},5e3)})}function c(){$.getJSON(theQuery.request1(),function(a){return void 0===a.rates[0]?(fail("Your search returned no results.","Please make sure your search query is valid, and try again."),!1):(result=a.rates[0],ratei=0,data.push(a.rates[0]),void 0)}).success(function(){data[0].rate.length>1?chooseRates(data):(process(),view(a))}).error(function(){setTimeout(function(){c()},5e3)})}$("#fail").html(""),$("#load").show(),$(window).width()<699&&$("html, body").animate({scrollTop:$("#load").offset().top},500),$("#chooseRates").hide(),$("#results").hide(),"permalink"!==a?(startDate=moment($("#startDate").val(),"YYYY-MM-DD"),endDate=moment($("#endDate").val(),"YYYY-MM-DD")):(startDate=moment(startDate,"YYYY-MM-DD"),endDate=moment(endDate,"YYYY-MM-DD")),startYear=startDate.year(),endYear=endDate.year(),"geo"===a&&(theQuery=new Query(baseURL,geoZip,"",""),startDate=today,endDate=today),"main"===a&&(theQuery=new Query(baseURL,$("#queryZip").val(),$("#queryCity").val(),stateAbbrev($("#queryState").val()))),"permalink"===a&&(theQuery=new Query(baseURL,permaZip,permaCity,permaState)),data=[],2015===startYear?b():b(2),startTimers()}function Query(a,b,c,d){var e="year/"+startYear+"/",f="year/"+parseInt(startYear+1)+"/",g="",h="",i="";c.length>0&&(g="city/"+c+"/"),d.length>0&&(h="state/"+d+"/"),b.length>0&&(i="zip/"+b+"/",g="",h=""),this.zip=function(){return b},this.city=function(){return c},this.state=function(){return d},this.year=function(){return date.year()},this.request=function(){return a+g+h+i+e},this.request1=function(){return a+g+h+i+f}}function DoMath(){if(startYear===endYear)var a=Math.abs(endDate.month()-startDate.month());else var a=Math.abs(endDate.month()+12-startDate.month());for(var b=[],c=0;a>=c;c++){var g,d=moment(startDate).add("months",c),e=d.month(),f=d.year(),h=theRates.lodging(e,f),i=theRates.mie(f);if(g=0===c?startDate.month()===endDate.month()?endDate.date()-startDate.date()+1:startDate.daysInMonth()-startDate.date()+1:c===a?endDate.date():d.daysInMonth(),c===a)var j=(g-1)*h;else var j=g*h;if(startDate.month()===endDate.month())var k=(g-2)*i+2*.75*i;else if(0===c||c===a)var k=(g-1)*i+.75*i;else var k=g*i;var l=k+j;b.push([e,f,g,h,i,j,k,l])}for(var m=0,n=0,k=0,o=0,c=0;c<b.length;c++)0===c?m=m+b[c][2]-1:m+=b[c][2],n+=b[c][5],k+=b[c][6],o+=b[c][7];var p=b.length-1;o=k+n;var q=.75*b[0][4],r=.75*b[p][4];this.firstDayMIE=function(){return q},this.lastDayMIE=function(){return r},this.array=function(){return b},this.totalLodging=function(){return n},this.totalMIE=function(){return k},this.totalDays=function(){return m},this.total=function(){return o}}function Rates(){this.lodging=function(a,b){function d(a,b){for(i=0;12>i;i++)if(b[i].number==a)return monthRate=parseInt(b[i].value)}if(b!==startYear)var c=1;else var c=0;if(a>8&&b===startYear)var c=1;var e=d(a+1,data[c].rate[ratei].months.month);return e},this.mie=function(a){var b=0;if(a!==startYear)var b=1;return data[b].rate[ratei].meals}}function view(a){clearTimers();var b=theMath.array();$("#fail").hide(),$("#results table tbody").html(""),$("#results #totals ul").remove(),$("#results #totals").hide(),$("#results #today").hide(),$("#chooseRates ul").html(""),$("#chooseRates").hide(),$("#results #yourSearch").html("Your search "+searchedFor()+"matches results for "+data[0].rate[ratei].city+", including "+county(data[0].rate[ratei].county)+":"),"geo"===a||(startDate.format("YYYY-MM-DD")!==endDate.format("YYYY-MM-DD")?$("#results table tbody").append('<tr class="firstLast"><td scope="row">First Day</td><td>$'+currency(b[0][3])+"</td><td>$"+currency(theMath.firstDayMIE())+"</td><td>$"+currency(b[0][3]+theMath.lastDayMIE())+"</td>"):$("#results table tbody").append('<tr class="firstLast"><td scope="row">First Day</td><td>N/A</td><td>$'+currency(theMath.firstDayMIE())+"</td><td>$"+currency(theMath.firstDayMIE())+"</td>")),$.each(b,function(a){$("#results table tbody").append('<tr><td scope="row">'+theMonths[b[a][0]]+" Rate</td><td>$"+currency(b[a][3])+"</td><td>$"+currency(b[a][4])+"</td><td>$"+currency(b[a][3]+b[a][4])+"</td>")}),startDate.format("YYYY-MM-DD")!==endDate.format("YYYY-MM-DD")&&$("#results table tbody").append('<tr class="firstLast"><td scope="row">Last Day</td><td>-</td><td>$'+currency(theMath.lastDayMIE())+"</td><td>$"+currency(theMath.lastDayMIE())+"</td>"),"geo"===a?$("#today").show():startDate.format("YYYY-MM-DD")===endDate.format("YYYY-MM-DD")?($("#totals h4 strong").html("$"+currency(theMath.lastDayMIE())),$("#totals").append('<ul class="unstyled"><li>Lodging <strong>N/A</strong></li><br><li>M&amp;IE <strong>$'+currency(theMath.lastDayMIE())+"</strong></li></ul>").show()):($("#totals h4 strong").html("$"+currency(theMath.total())),$("#totals").append('<ul class="unstyled"><li>Lodging <strong>$'+currency(theMath.totalLodging())+"</strong></li><br><li>M&amp;IE <strong>$"+currency(theMath.totalMIE())+"</strong></li></ul>").show()),"geo"===a?($("#results #saveSearch .link").val(mRoot+"/#!/travel/perdiem/?mylocation"),$("#saveSearch .email").attr("href","mailto:?subject=My%20Per%20Diem%20Rates&body=http%3A%2F%2Fm.gsa.gov%2Fm%2F%23%21%2Ftravel%2Fperdiem%2F%3Fmylocation")):($("#results #saveSearch .link").val(mRoot+"/#!/travel/perdiem/?start="+startDate.format("YYYY-MM-DD")+"&end="+endDate.format("YYYY-MM-DD")+"&zip="+theQuery.zip()+"&city="+theQuery.city()+"&state="+theQuery.state()),$("#saveSearch .email").attr("href","mailto:?subject=My%20Per%20Diem%20Rates&body=http%3A%2F%2Fm.gsa.gov%2Fm%2F%23%21%2Ftravel%2Fperdiem%2F%3Fstart%3D"+startDate.format("YYYY-MM-DD")+"%26end%3D"+endDate.format("YYYY-MM-DD")+"%26zip%3D"+theQuery.zip()+"%26city%3D"+theQuery.city()+"%26state%3D"+theQuery.state())),$("#load").hide(),$("#results").css("opacity","0").show().addClass("fadeInDown animated"),$(window).width()<699&&$("html, body").animate({scrollTop:$("#results").offset().top},500)}function analytics(a){"undefined"!=typeof _gaq&&_gaq.push(["_trackEvent","Per Diem",a])}function searchedFor(){var a;return $("#queryCity").val().length>0?a=capitalize($("#queryCity").val()):0===$("#queryCity").val().length&&0===$("#queryZip").val().length||(a=$("#queryZip").val()),a=void 0!=a?'for "'+a+'" ':""}function county(a){return a.indexOf(",")>0&&0===a.indexOf("counties")?a+" counties":a.indexOf("(")>0||a.indexOf(";")>0?a:a+" county"}function process(){theRates=new Rates,theMath=new DoMath}function fail(a,b,c){$("#fail").hide(),c!==!1&&$("#load").hide(),$("#results").hide(),void 0===a?$("#fail").html("").append('<div class="alert alert-error"><h4>Your Search Returned No Results.</h4><br><p>Please try again.</p></div>'):$("#fail").html("").append('<div class="alert alert-error"><h4>'+a+"</h4><br><p>"+b+"</p></div>"),$(window).width()<699&&$("html, body").animate({scrollTop:$("#fail").offset().top},500),$("#fail").show()}function chooseRates(a){$("#chooseRates ul").html(""),$.each(a[0].rate,function(b){""===a[0].rate[b].city?$("#chooseRates ul").append('<li><a href="#">All other locations</a></li>'):$("#chooseRates ul").append('<li><a href="#">'+a[0].rate[b].city+"</a></li>")}),$("#chooseRates").css("opacity","0").show().addClass("fadeInDown animated"),$("#load").hide(),$(window).width()<699&&$("html, body").animate({scrollTop:$("#chooseRates").offset().top},500),$("#chooseRates li").click(function(){var b=$(this).index();return ratei=b,a.push(a[0]),$("#load").show(),process(),startDate.format("YYYY-MM-DD")===endDate.format("YYYY-MM-DD")?view(!1):view(),!1}),clearTimers()}function stateAbbrev(a){return a=a.toLowerCase(),a.length>2?void 0!=theStates[a]?theStates[a]:"":a.toUpperCase()}function daysInMonth(a,b){return new Date(b,a,0).getDate()}function currency(a){return-1!==a.toString().indexOf(".")?a.toFixed(2):a+".00"}function capitalize(a){return a.charAt(0).toUpperCase()+a.slice(1)}function getLocation(){Modernizr.geolocation?(navigator.geolocation.getCurrentPosition(reverseGeocode,geocodeError),geocoder=new google.maps.Geocoder,$("#load").show(),$(window).width()<699&&$("html, body").animate({scrollTop:$("#load").offset().top},500)):$("#geoLocation").addClass("disabled").html("Geolocation is not available on this device")}function reverseGeocode(a){var b=a.coords.latitude,c=a.coords.longitude,d=new google.maps.LatLng(b,c);geocoder.geocode({latLng:d},function(a,b){if(b==google.maps.GeocoderStatus.OK){var c=a[0].address_components;for(i in c)"postal_code"===c[i].types[0]&&(geoZip=c[i].long_name);perDiemSearch("geo"),$("#geoLocation").addClass("disabled")}else fail("Your location could not be determined.","Try searching manually, or set your device to allow location access.")})}function geocodeError(a){var b="";switch(a.code){case a.PERMISSION_DENIED:b="<h4>You have disallowed access to your location.</h4><br><p>Try searching manually, or set your device to allow location access.</p>";break;case a.POSITION_UNAVAILABLE:b="<h4>Your location could not be determined.</h4><br><p>Try searching manually, or enabling your device's data, WiFi, and location services.</p>";break;case a.PERMISSION_DENIED_TIMEOUT:b="<div class='alert alert-error'><h4>Your location could not be determined.</h4><br><p>Try searching manually, or enabling your device's data, WiFi, and location services.</p></div>"}""==b&&(b="<h4>Your location could not be determined due to an unknown error.</h4><br><p>Try searching manually, or enabling your device's data, WiFi, and location services.</p>"),$("#fail").html(""),$("#results").hide(),$("#fail").append("<div class='alert alert-error'>"+b+"</div>").show(),$("#load").hide()}function permalink(){var a=window.location.href.split("?");urlVars=a[1].split("&"),startDate=urlVars[0].replace("start=",""),endDate=urlVars[1].replace("end=",""),permaZip=urlVars[2].replace("zip=",""),permaCity=urlVars[3].replace("city=",""),permaState=urlVars[4].replace("state=",""),""!==permaCity&&$("#queryCity").val(permaCity),""!==permaState&&$("#queryState").val(permaState),""!==permaZip&&$("#queryZip").val(permaZip),$("#startDate").val(startDate),$("#endDate").val(endDate),perDiemSearch("permalink"),analytics("Permalink")}function startTimers(){timer10=setTimeout(function(){fail("This seems to be taking a while...","Loading results requires an internet connection. If you're mobile, make sure you are still connected to 3G/4G/WiFi.",!1)},11e3),timer30=setTimeout(function(){fail("This seems to be taking a while...","This app will continue trying to collect results until you search again, or navigate to another page.",!1)},31e3)}function clearTimers(){clearTimeout(timer10),clearTimeout(timer30)}var baseURL=root+"/api/rs/perdiem/",data,topLevelData,stateAbbrev,theQuery,geocoder,geoZip,permaZip,urlVars,today,startDate,endDate,startYear,endYear,theRates,theMath,ratei,timer10,timer30;$(function(){today=moment(),$("#startDate").val(today.format("YYYY-MM-DD")),$("#endDate").val(today.add("days",1).format("YYYY-MM-DD")),window.location.href.indexOf("?start")>0&&permalink(),window.location.href.indexOf("?mylocation")>0&&(analytics("Geolocation"),getLocation()),$("#search").click(function(){return validateInput(),!1}),$("#searchAgain").click(function(){$("#searchBox").show(),$(window).width()<699&&$("html, body").animate({scrollTop:$("body").offset().top},500)}),$("#geoLocation").click(function(){return $("#queryState,#queryCity,#queryZip").val(""),analytics("Geolocation"),getLocation(),!1}),$("#saveSearch .link").click(function(){this.select()}),$("#saveSearch button").click(function(){window.location.href=$(this).attr("href")})}),String.prototype.inRange=function(a,b){var c=parseInt(this);return c>a&&b>c},String.prototype.hasPrefix=function(a){var b=this.substring(0,3);return b===a?!0:!1};var theMonths=["January","February","March","April","May","June","July","August","September","October","November","December"],theStates={alabama:"al",alaska:"ak",arizona:"az",arkansas:"ar",california:"ca",colorado:"co",connecticut:"ct",delaware:"de",florida:"fl",georgia:"ga",hawaii:"hi",idaho:"id",illinois:"il",indiana:"in",iowa:"ia",kansas:"ks",kentucky:"ky",louisiana:"la",maine:"me",maryland:"md",massachusetts:"ma",michigan:"mi",minnesota:"mn",mississippi:"ms",missouri:"mo",montana:"mn",nebraska:"ne",nevada:"nv","new hampshire":"nh","new jersey":"nj","new mexico":"nm","new york":"ny","north carolina":"nc","north dakota":"nd",ohio:"oh",oklahoma:"ok",oregon:"or",pennsylvania:"pa","rhode island":"ri","south carolina":"sc","south dakota":"sd",tennessee:"tn",texas:"tx",utah:"ut",vermont:"vt",virginia:"va",washington:"wa","west virginia":"wv",wisconsin:"wi",wyoming:"wy"};